import { ChevronLeftIcon } from '@heroicons/react/24/outline';
import Breadcrumb from 'components/common/Breadcrumb';
import Button from 'components/common/Button';
import Divider from 'components/common/Divider';
import PageNavigation from 'components/common/PageNavigation';
import AddressForm from 'components/exploits/AddressForm';
import ExploitCard from 'components/exploits/ExploitCard';
import ExploitChecker from 'components/exploits/ExploitChecker';
import ContentPageLayout from 'layouts/ContentPageLayout';
import { AddressPageContextProvider } from 'lib/hooks/page-context/AddressPageContext';
import { ISidebarEntry } from 'lib/interfaces';
import { defaultSEO } from 'lib/next-seo.config';
import { Exploit, formatExploitAmount, getAllExploits, getUniqueChainIds } from 'lib/utils/exploits';
import { GetStaticPaths, GetStaticProps } from 'next';
import { NextSeo } from 'next-seo';
import useTranslation from 'next-translate/useTranslation';
import { useState } from 'react';
import { Address } from 'viem';

interface Props {
  exploit: Exploit;
  navigationalPages: Array<ISidebarEntry>;
}

const ExploitDetailsPage = ({ exploit, navigationalPages }: Props) => {
  const { t } = useTranslation();
  const [address, setAddress] = useState<Address | undefined>();

  const year = String(new Date(exploit.date).getFullYear());
  const exploitName = exploit.name.includes(year) ? exploit.name : `${year} ${exploit.name}`;
  const amount = formatExploitAmount(exploit.amount);
  const date = exploit.date;

  return (
    <>
      <NextSeo
        {...defaultSEO}
        title={t('exploits:subpages.meta.title', { exploitName, amount })}
        description={t('exploits:subpages.meta.description', { exploitName, amount, date })}
        openGraph={{
          url: `https://revoke.cash/exploits/${exploit.slug}`,
          images: [
            {
              url: `https://revoke.cash/api/og/exploits/${exploit.slug}`,
              width: 1200,
              height: 630,
            },
          ],
          site_name: 'Revoke.cash',
          type: 'website',
        }}
      />

      <ContentPageLayout searchBar={false}>
        <Breadcrumb pages={[{ name: t('common:nav.exploits'), href: '/exploits' }, { name: exploit.name }]} />
        <div className="flex flex-col gap-4">
          <div>
            <h1 className="text-5xl">{exploit.name}</h1>
            <p className="text-2xl font-light">{t('exploits:subpages.subtitle')}</p>
          </div>

          <ExploitCard exploit={exploit} />

          <AddressPageContextProvider address={address} initialChainId={getUniqueChainIds(exploit)[0]}>
            <AddressForm onSubmit={setAddress} chainIds={getUniqueChainIds(exploit)} />
            <ExploitChecker exploit={exploit} />
          </AddressPageContextProvider>
        </div>
        <Divider className="my-6" />
        <PageNavigation currentPath={`/exploits/${exploit.slug}`} pages={navigationalPages} />
        <Button
          size="md"
          style="secondary"
          href="/exploits"
          className="w-fit gap-2 pl-3 border-zinc-300 dark:border-zinc-700"
          router
        >
          <ChevronLeftIcon className="h-5 w-5" />
          {t('common:buttons.back_to_exploits')}
        </Button>
      </ContentPageLayout>
    </>
  );
};

export const getStaticProps: GetStaticProps<Props> = async (context) => {
  const exploits = await getAllExploits();
  const exploitIndex = exploits.findIndex((e) => e.slug === context.params.slug);

  const exploit = exploits[exploitIndex];

  // Only extract the page titles and paths for the pages before and after the current page for navigation
  const navigationalPages = exploits
    .slice(Math.max(exploitIndex - 1, 0), Math.min(exploitIndex + 2, exploits.length))
    .map((exploit) => ({ title: exploit.name, path: `/exploits/${exploit.slug}` }));

  return {
    props: {
      exploit,
      navigationalPages,
    },
  };
};

export const getStaticPaths: GetStaticPaths = async ({ locales }) => {
  const exploits = await getAllExploits();

  const paths = locales.flatMap((locale) =>
    exploits.map((exploit) => ({
      params: {
        slug: exploit.slug,
      },
      locale,
    })),
  );

  return {
    paths,
    fallback: false,
  };
};

export default ExploitDetailsPage;
