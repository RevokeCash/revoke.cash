// Note: this file contains TypeScript errors, but these errors are incorrect. I'm not sure how to fix them.

import { getChainLogo, getChainName, isSupportedChain } from 'lib/utils/chains';
import { Exploit, formatExploitAmount, getExploitBySlug, getUniqueChainIds } from 'lib/utils/exploits';
import { ImageResponse, NextRequest } from 'next/server';

export const config = {
  runtime: 'edge',
  unstable_allowDynamic: ['/node_modules/gray-matter/**', '/node_modules/js-yaml/**'],
};

// @ts-ignore
const revokeIcon = fetch(new URL('/public/assets/images/revoke.png', import.meta.url)).then((res) => res.arrayBuffer());

const OgImage = async (req: NextRequest) => {
  const { searchParams } = new URL(req.url);
  const slug = searchParams.get('slug');

  let exploit: Exploit;

  try {
    exploit = await getExploitBySlug(slug, 'en');
  } catch (e) {
    return new Response('Not found', { status: 404 });
  }

  const numberOfChains = getUniqueChainIds(exploit).length;
  const numberOfChainsStr = numberOfChains > 1 ? `${numberOfChains} Affected Networks` : '1 Affected Network';

  const response = (
    <div tw="bg-white w-full h-full flex flex-col text-4xl leading-none items-center justify-center px-16">
      <img width="400" src={(await revokeIcon) as any} />
      <div tw="text-6xl leading-none mt-8 mb-2">{exploit.name}</div>
      <div>{`${exploit.date} | ${formatExploitAmount(exploit.amount)} Stolen | ${numberOfChainsStr}`}</div>
      <div tw="flex mt-8 mb-12">
        {getUniqueChainIds(exploit).map((chainId, index) => (
          <ChainLogo chainId={chainId} key={index} />
        ))}
      </div>
      <div tw="border-2 border-black bg-black text-white text-5xl py-4 pl-8 pr-6 rounded-3xl flex items-center justify-center w-full shadow-xl">
        <div>Check If You're Affected</div>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          // @ts-ignore
          tw="w-16 h-16 ml-4"
        >
          <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
        </svg>
      </div>
    </div>
  );

  return new ImageResponse(response, {
    width: 1200,
    height: 630,
  });
};

const ChainLogo = ({ chainId, size }: { chainId: number; size?: number }) => {
  const name = getChainName(chainId);
  const src = getChainLogo(chainId);

  return (
    <img
      src={`https://revoke.cash/${src}`}
      alt={name}
      width={size ?? 48}
      height={size ?? 48}
      tw="bg-white shrink-0 rounded-full mx-1 border border-black"
      style={{
        filter: !isSupportedChain(chainId) ? 'grayscale(100%)' : '',
      }}
    />
  );
};

export default OgImage;
