import ContentPageLayout from 'app/layouts/ContentPageLayout';
import Divider from 'components/common/Divider';
import Prose from 'components/common/Prose';
import ExploitCard from 'components/exploits/ExploitCard';
import ReportExploitButton from 'components/exploits/ReportExploitButton';
import { getAllExploits, getGlobalExploitStats } from 'lib/utils/exploits';
import { getOpenGraphImageUrl } from 'lib/utils/og';
import type { Metadata, NextPage } from 'next';
import { getTranslations, unstable_setRequestLocale } from 'next-intl/server';

interface Props {
  params: {
    locale: string;
  };
}

export const dynamic = 'error';

export const generateMetadata = async ({ params: { locale } }: Props): Promise<Metadata> => {
  const t = await getTranslations({ locale });
  const exploits = await getAllExploits();
  const { totalAmount, earliestYear } = getGlobalExploitStats(exploits);

  return {
    title: t('exploits.meta.title'),
    description: t('exploits.meta.description', { totalAmount, earliestYear }),
    openGraph: {
      images: getOpenGraphImageUrl('/exploits', locale),
    },
  };
};

const ExploitOverviewPage: NextPage<Props> = async ({ params }) => {
  unstable_setRequestLocale(params.locale);

  const exploits = await getAllExploits();
  const { totalAmount, earliestYear } = getGlobalExploitStats(exploits);
  const t = await getTranslations({ locale: params.locale });

  return (
    <ContentPageLayout>
      <div className="flex flex-col gap-4 max-w-3xl mx-auto">
        <div className="flex sm:flex-row flex-wrap gap-2 items-center justify-between not-prose">
          <div>
            <h1 className="mb-1">{t('exploits.title')}</h1>
            <p>{t('exploits.subtitle', { totalAmount, earliestYear })}</p>
          </div>
          <ReportExploitButton />
        </div>
        <Divider />
        <Prose>
          <p>{t('exploits.description')}</p>
        </Prose>
        {exploits.map((exploit) => (
          <ExploitCard key={exploit.slug} exploit={exploit} overview />
        ))}
      </div>
    </ContentPageLayout>
  );
};

export default ExploitOverviewPage;
