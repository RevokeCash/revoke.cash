import { locales } from 'lib/i18n/config';
import { getChainLogo, getChainName, isSupportedChain } from 'lib/utils/chains';
import { formatExploitAmount, getAllExploits, getExploitBySlug, getUniqueChainIds } from 'lib/utils/exploits';
import { loadDataUrl, loadFile } from 'lib/utils/og';
import { getTranslations } from 'next-intl/server';
import { ImageResponse } from 'next/og';

interface Props {
  params: Promise<Params>;
}

interface Params {
  locale: string;
  slug: string;
}

export const dynamic = 'error';
export const dynamicParams = false;

export const generateStaticParams = async () => {
  const exploits = await getAllExploits();
  return locales.flatMap((locale) => exploits.map((exploit) => ({ locale, slug: exploit.slug })));
};

export async function GET(req: Request, { params }: Props) {
  const { locale, slug } = await params;
  const icon = loadDataUrl('public/assets/images/revoke-icon-orange-black.png', 'image/png');

  const t = await getTranslations({ locale });
  const exploit = await getExploitBySlug(slug, locale);

  const uniqueChainIds = getUniqueChainIds(exploit);

  const numberOfChainsStr = t('exploits.meta.og.chains', { count: uniqueChainIds.length });
  const stolenAmountStr = t('exploits.meta.og.amount', { amount: formatExploitAmount(exploit.amount) });

  const response = (
    <div tw="bg-white w-full h-full flex flex-col text-4xl leading-none items-center justify-center px-16">
      <div tw="text-7xl leading-none mb-10" style={{ fontFamily: 'Inter SemiBold' }}>
        {exploit.name}
      </div>
      <div style={{ display: 'flex', fontFamily: 'Inter' }}>
        <div>{exploit.date}</div>
        <div tw="border-r border-black h-full mx-8" />
        <div>{stolenAmountStr}</div>
        <div tw="border-r border-black h-full mx-8" />
        <div>{numberOfChainsStr}</div>
      </div>
      <div tw="flex mt-8 mb-12 items-center" style={{ display: 'flex', fontFamily: 'Inter' }}>
        {uniqueChainIds.slice(0, 16).map((chainId) => (
          <ChainLogo chainId={chainId} key={chainId} />
        ))}
        {uniqueChainIds.length > 16 && <div tw="ml-1">{`+${uniqueChainIds.length - 16}`}</div>}
      </div>
      <div tw="flex items-center justify-center">
        <div tw="border-2 border-black bg-black text-white text-4xl py-4 px-10 h-[78px]">
          {t('exploits.meta.og.check')}
        </div>
        <img src={icon} height="78" alt="Revoke icon" />
      </div>
    </div>
  );

  return new ImageResponse(response, {
    width: 1200,
    height: 630,
    fonts: [
      { name: 'Inter SemiBold', data: loadFile('public/assets/fonts/Inter-SemiBold.ttf') },
      { name: 'Inter', data: loadFile('public/assets/fonts/Inter-Regular.ttf') },
    ],
  });
}

const ChainLogo = ({ chainId, size }: { chainId: number; size?: number }) => {
  const name = getChainName(chainId);
  const src = getChainLogo(chainId);

  return (
    <img
      src={`https://revoke.cash/${src}`}
      alt={name}
      width={size ?? 48}
      height={size ?? 48}
      tw="bg-white shrink-0 rounded-full mx-1 border border-black"
      style={{
        filter: !isSupportedChain(chainId) ? 'grayscale(100%)' : '',
      }}
    />
  );
};
